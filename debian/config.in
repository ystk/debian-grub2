#!/bin/sh
set -e

case `dpkg --print-architecture` in
  kfreebsd-*)
    # No migration from GRUB Legacy, no Linux cmdline
    exit 0
  ;;
esac

. /usr/share/debconf/confmodule

priority=medium

case @PACKAGE@ in
  grub-pc)
    if test -e /boot/grub/stage2 && test -e /boot/grub/menu.lst && ! test -e /boot/grub/core.img ; then

      db_input high grub-pc/chainload_from_menu.lst || true

      db_get grub-pc/kopt_extracted || true
      # this check ensures we only do this once
      if [ "$RET" = "false" ] ; then
        kopt=`sed -ne "s/^# kopt=//p" /boot/grub/menu.lst | tr -s " " "\n" | grep -vx "\(ro\|root=[^ ]*\)" | paste -s -d ' '` || true
        db_set grub2/linux_cmdline "${kopt}" || true
        db_set grub-pc/kopt_extracted true || true
        if [ "${kopt}" = "" ] ; then
          # something smells bad.  give user a chance to correct it.
          priority=high
        else
          # if we got something from menu.lst, it must be correct?
          priority=medium
        fi
      fi
    fi
  ;;
esac

if test -e /etc/default/grub ; then
  . /etc/default/grub

  db_set grub2/linux_cmdline "$GRUB_CMDLINE_LINUX"
  db_set grub2/linux_cmdline_default "$GRUB_CMDLINE_LINUX_DEFAULT"
fi

db_input ${priority} grub2/linux_cmdline || true
db_input medium grub2/linux_cmdline_default || true
db_go
